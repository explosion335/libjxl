name: Extreme Release Build (Zen 3 / 5800U)
on:
  push:
  workflow_dispatch:

jobs:
  windows_build:
    name: MinGW-w64 GCC / Zen 3 Optimized
    runs-on: windows-latest
    steps:
      - name: Checkout the source
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-brotli
            mingw-w64-x86_64-giflib
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-libwebp

      - name: Build and Optimize
        shell: msys2 {0}
        run: |
          # 1. DEFINE EXTREME 5800U FINGERPRINT FLAGS
          GREP_FLAGS="-march=znver3 -mmmx -mpopcnt -msse -msse2 -msse3 -mssse3 -msse4.1 -msse4.2 \
          -mavx -mavx2 -msse4a -mno-fma4 -mno-xop -mfma -mno-avx512f -mbmi -mbmi2 -maes -mpclmul \
          -mno-avx512vl -mno-avx512bw -mno-avx512dq -mno-avx512cd -mno-avx512vbmi -mno-avx512ifma \
          -mno-avx512vpopcntdq -mno-avx512vbmi2 -mno-gfni -mvpclmulqdq -mno-avx512vnni -mno-avx512bitalg \
          -mno-avx512bf16 -mno-avx512vp2intersect -mno-3dnow -madx -mabm -mno-cldemote -mclflushopt \
          -mclwb -mclzero -mcx16 -mno-enqcmd -mf16c -mfsgsbase -mfxsr -mno-hle -msahf -mno-lwp -mlzcnt \
          -mmovbe -mno-movdir64b -mno-movdiri -mno-mwaitx -mno-pconfig -mno-pku -mprfchw -mno-ptwrite \
          -mrdpid -mrdrnd -mrdseed -mno-rtm -mno-serialize -mno-sgx -msha -mshstk -mno-tbm -mno-tsxldtrk \
          -mvaes -mno-waitpkg -mno-wbnoinvd -mxsave -mxsavec -mxsaveopt -mxsaves -mno-amx-tile -mno-amx-int8 \
          -mno-amx-bf16 -mno-uintr -mno-hreset -mno-kl -mno-widekl -mno-avxvnni -mno-avx512fp16 -mno-avxifma \
          -mno-avxvnniint8 -mno-avxneconvert -mno-cmpccxadd -mno-amx-fp16 -mno-prefetchi -mno-raoint \
          -mno-amx-complex -mno-avxvnniint16 -mno-sm3 -mno-sha512 -mno-sm4 -mno-apxf -mno-usermsr \
          -mno-avx10.2 -mno-amx-avx512 -mno-amx-tf32 -mno-amx-transpose -mno-amx-fp8 -mno-movrs -mno-amx-movrs \
          --param l1-cache-size=32 --param l1-cache-line-size=64 --param l2-cache-size=512 -mtune=znver3"

          PERF_OPTS="-Ofast -flto=auto -funroll-loops -fomit-frame-pointer -fstrict-aliasing -s"
          
          export CFLAGS="$PERF_OPTS $GREP_FLAGS"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-flto=auto -s -static"

          # 2. CONFIGURE WITH CMAKE
          # Note: We disable Highway's internal SIMD detection to force our Zen 3 flags
          mkdir build && cd build
          cmake .. -G"Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DJPEGXL_STATIC=ON \
            -DJPEGXL_ENABLE_TOOLS=ON \
            -DJPEGXL_ENABLE_BENCHMARK=ON \
            -DJPEGXL_ENABLE_EXAMPLES=OFF \
            -DBUILD_TESTING=OFF \
            -DJPEGXL_BUNDLE_LIBPNG=OFF \
            -DJPEGXL_ENABLE_SKCMS=ON \
            -DJPEGXL_FORCE_SYSTEM_BROTLI=ON \
            -DJPEGXL_FORCE_SYSTEM_HWY=OFF

          # 3. BUILD
          ninja

      - name: Package
        shell: msys2 {0}
        run: |
          mkdir prefix
          cp build/tools/cjxl.exe prefix/
          cp build/tools/djxl.exe prefix/
          cp build/tools/benchmark_xl.exe prefix/
          # Copy licenses
          cp LICENSE prefix/

      - name: Upload Optimized JXL
        uses: actions/upload-artifact@v4
        with:
          name: jxl-5800u-extreme
          path: prefix/